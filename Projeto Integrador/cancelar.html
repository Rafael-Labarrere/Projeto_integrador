<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancelar Reservas - UniCEUB</title>
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <nav>
        <div class="logo">UniCEUB</div>
        <ul class="menu">
            <li><a href="inicio.html">Início</a></li>
            <li><a href="consultar_salas.html">Consultar Salas</a></li>
            <li><a href="historico.html">Minhas Reservas</a></li>
            <li><a href="cancelar.html">Cancelar Reservas</a></li>
            <li class="login"><a href="loggedin.html">Área do Usuário</a></li>
        </ul>
    </nav>

    <main>
        <section class="intro">
            <h1>UniCEUB</h1>
            <h3>Bem-vindo ao Sistema de Reserva de Salas do UniCEUB!</h3>
            <p>Este sistema foi desenvolvido para facilitar o cancelamento de suas reservas.</p>
        </section>

        <section class="content">
            <h2>Cancelar Reservas</h2>
            <div id="loading" style="text-align: center; padding: 20px; display: none;">
                <p>Carregando reservas...</p>
            </div>

            <div id="reservas-cancelar">
                <table id="tabela-cancelar">
                    <thead>
                        <tr>
                            <th>Sala</th>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Status</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 UniCEUB - Todos os direitos reservados</p>
    </footer>

    <script type="module">
        import { verificarAutenticacao } from './auth.js'; 

        // A URL base da API é definida no auth.js, e importamos.
        // No entanto, para evitar problemas de escopo ou para clareza em cada arquivo,
        // podemos definir a base aqui ou obter do auth.js se exportado (não está exportado).
        // Vamos manter a definição explícita aqui, consistente com auth.js
        const API_URL = 'https://projeto-integrador-znob.onrender.com';

        document.addEventListener('DOMContentLoaded', async () => {
            const autenticado = await verificarAutenticacao();
            if (autenticado) {
                carregarReservasParaCancelar();
            } else {
                // verificarAutenticacao já deve ter redirecionado, mas para garantir uma mensagem clara:
                document.querySelector('#tabela-cancelar tbody').innerHTML = `<tr><td colspan="5">Você precisa fazer login para ver e cancelar suas reservas.</td></tr>`;
                document.getElementById('loading').style.display = 'none';
            }
        });

        async function carregarReservasParaCancelar() {
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
            const tbody = document.querySelector('#tabela-cancelar tbody');
            const loading = document.getElementById('loading');

            if (!usuario || !usuario.id) { // Não precisa verificar o token aqui se o backend não exige
                tbody.innerHTML = `<tr><td colspan="5">Você não está logado ou sua sessão expirou. <a href="login.html">Faça login</a></td></tr>`;
                loading.style.display = 'none';
                return;
            }

            loading.style.display = 'block';
            tbody.innerHTML = ''; // Limpa a tabela antes de carregar novas reservas

            try {
                // ASSUMINDO QUE SEU SERVER.JS NÃO EXIGE AUTORIZAÇÃO PARA ESTA ROTA GET
                const response = await fetch(`${API_URL}/api/reservas/usuario/${usuario.id}`); 
                
                if (!response.ok) {
                    const errorMsg = await response.json(); // Tenta ler a mensagem de erro
                    throw new Error(errorMsg.error || `Erro ao carregar reservas: Status ${response.status}`);
                }

                const reservas = await response.json();

                if (reservas.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5">Nenhuma reserva encontrada para cancelar.</td></tr>`;
                } else {
                    reservas.forEach(reserva => {
                        const tr = document.createElement('tr');
                        const statusColor = getStatusColor(reserva.status);

                        const dataFormatada = formatarData(reserva.data);
                        const horarioFormatado = formatarHorario(reserva.horario);

                        tr.innerHTML = `
                            <td>${reserva.sala_nome} (${reserva.bloco}, ${reserva.tipo})</td>
                            <td>${dataFormatada}</td>
                            <td>${horarioFormatado}</td>
                            <td><span style="color: ${statusColor}; font-weight: bold;">${reserva.status || 'Pendente'}</span></td>
                            <td>
                                ${ (reserva.status !== 'Cancelado' && reserva.status !== 'Rejeitado') ?
                                    `<button onclick="cancelarReserva('${reserva.id}')" style="background-color:#dc3545;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">Cancelar</button>`
                                    :
                                    `<button disabled style="background-color:#6c757d;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:not-allowed;">${reserva.status === 'Cancelado' ? 'Cancelada' : 'Rejeitada'}</button>`
                                }
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (err) {
                console.error("Erro ao carregar reservas:", err);
                tbody.innerHTML = `<tr><td colspan="5">Erro ao carregar reservas: ${err.message || err}.</td></tr>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Funções de formatação e statusColor (iguais às anteriores)
        function formatarData(data) {
            if (!data) return '';
            try {
                // Adapte se o formato da sua data for diferente (e.g., 'YYYY-MM-DDTHH:mm:ss.sssZ')
                const [ano, mes, dia] = data.split('-');
                return `${dia}/${mes}/${ano}`;
            } catch {
                return data; 
            }
        }

        function formatarHorario(horario) {
            if (!horario) return '';
            try {
                const [hora, minuto] = horario.split(':');
                return `${hora}:${minuto}`;
            } catch {
                return horario;
            }
        }

        function getStatusColor(status) {
            switch ((status || '').toLowerCase()) {
                case 'confirmado':
                case 'aprovado':
                    return '#28a745'; 
                case 'cancelado':
                case 'rejeitado':
                    return '#dc3545'; 
                case 'pendente':
                default:
                    return '#ffc107'; 
            }
        }

        window.cancelarReserva = async function(idReserva) {
            const confirmar = confirm("Tem certeza que deseja cancelar esta reserva?");
            if (!confirmar) return;

            const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
            // Para o cancelamento, é crucial ter o token, pois a rota PATCH deve estar protegida
            if (!usuario || !usuario.token) {
                alert('Sessão expirada. Faça login novamente.');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/reservas/${idReserva}/cancelar`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${usuario.token}` // Envia o token aqui
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro desconhecido ao cancelar reserva');
                }

                const responseData = await response.json();
                alert(responseData.message || "Reserva cancelada com sucesso.");
                carregarReservasParaCancelar(); // Recarrega a tabela para refletir a mudança
            } catch (err) {
                console.error("Erro ao cancelar reserva:", err);
                alert("Erro ao cancelar reserva: " + (err.message || err));
            }
        }
    </script>
</body>
</html>