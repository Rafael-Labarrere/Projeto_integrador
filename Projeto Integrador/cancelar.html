<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página Inicial</title>
    <link rel="stylesheet" href="estilo.css">
    <script defer src="script.js"></script>
</head>
<body>
    <nav>
        <div class="logo">UniCEUB</div>
        <ul class="menu">
            <li><a href="inicio.html">Início</a></li>
            <li><a href="consultar_salas.html">Consultar Salas</a></li>
           
            <li><a href="historico.html">Minhas Reservas</a></li>
            <li><a href="cancelar.html">Cancelar Reservas</a></li>
            <li class="login"><a href="loggedin.html">Área do Usuário</a></li>
            
        </ul>
    </nav>

    <main>
        <section class="intro">
            <h1>UniCEUB</h1>
            <h3>Bem-vindo ao Sistema de Reserva de Salas do UniCEUB!</h3>
            <p>Este sistema foi desenvolvido para facilitar a reserva de salas dentro da universidade...</p>
        </section>

        <section class="content">
            <h2>Cancelar Reservas</h2>
            <div id="loading" style="text-align: center; padding: 20px; display: none;">
                <p>Carregando reservas...</p>
            </div>

            <div id="reservas-cancelar">
                <table id="tabela-cancelar">
                    <thead>
                        <tr>
                            <th>Sala</th>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Status</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Reservas aparecerão aqui -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>
    <script type="module">
  import { verificarAutenticacao, atualizarEstadoLogin } from './auth.js';

document.addEventListener('DOMContentLoaded', async () => {
    await verificarAutenticacao();
    atualizarEstadoLogin();
    carregarReservasParaCancelar();
});

async function carregarReservasParaCancelar() {
    const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
    const tbody = document.querySelector('#tabela-cancelar tbody');
    const loading = document.getElementById('loading');

    if (!usuario || !usuario.id) {
        tbody.innerHTML = `<tr><td colspan="5">Você não está logado. <a href="login.html">Faça login</a></td></tr>`;
        return;
    }

    loading.style.display = 'block';
    tbody.innerHTML = '';

    try {
        const response = await fetch(`https://projeto-integrador-znob.onrender.com/api/reservas/usuario/${usuario.id}`);
        if (!response.ok) throw new Error('Erro ao carregar reservas');

        const reservas = await response.json();

        if (reservas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5">Nenhuma reserva encontrada.</td></tr>`;
        } else {
            reservas.forEach(reserva => {
                const tr = document.createElement('tr');
                const statusColor = getStatusColor(reserva.status);

                tr.innerHTML = `
                    <td>${reserva.sala_nome} (${reserva.bloco}, ${reserva.tipo})</td>
                    <td>${formatarData(reserva.data_reserva)}</td>
                    <td>${formatarHorario(reserva.horario)}</td>
                    <td><span style="color: ${statusColor}; font-weight: bold;">${reserva.status || 'Pendente'}</span></td>
                    <td><button onclick="cancelarReserva('${reserva.id}')" style="background-color:#dc3545;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">Cancelar</button></td>
                `;

                tbody.appendChild(tr);
            });
        }
    } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="5">Erro ao carregar reservas.</td></tr>`;
    } finally {
        loading.style.display = 'none';
    }
}

function formatarData(data) {
    if (!data) return '';
    try {
        const [ano, mes, dia] = data.split('-');
        return `${dia}/${mes}/${ano}`;
    } catch {
        return data;
    }
}

function formatarHorario(horario) {
    if (!horario) return '';
    try {
        const [hora, minuto] = horario.split(':');
        return `${hora}:${minuto}`;
    } catch {
        return horario;
    }
}

function getStatusColor(status) {
    switch ((status || '').toLowerCase()) {
        case 'confirmado':
        case 'aprovado':
            return '#28a745';
        case 'cancelado':
        case 'rejeitado':
            return '#dc3545';
        case 'pendente':
        default:
            return '#ffc107';
    }
}

// função global para o botão funcionar
window.cancelarReserva = async function(idReserva) {
    const confirmar = confirm("Tem certeza que deseja cancelar esta reserva?");
    if (!confirmar) return;

    try {
        const response = await fetch(`https://projeto-integrador-znob.onrender.com/api/reservas/${idReserva}/cancelar`, {
            method: 'PATCH', // ou 'DELETE' dependendo do seu backend
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error('Erro ao cancelar reserva');

        alert("Reserva cancelada com sucesso.");
        carregarReservasParaCancelar(); // recarrega a tabela
    } catch (err) {
        console.error(err);
        alert("Erro ao cancelar reserva.");
    }
}
</script>

    <footer>
        <p>&copy; 2025 UniCEUB - Todos os direitos reservados</p>
    </footer>
</body>
</html>