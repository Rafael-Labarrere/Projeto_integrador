<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Reservas - UniCEUB</title>
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <nav>
        <div class="logo">UniCEUB</div>
        <ul class="menu">
            <li><a href="inicio.html">Início</a></li>
            <li><a href="consultar_salas.html">Consultar Salas</a></li>
            <li><a href="historico.html">Minhas Reservas</a></li>
            <li><a href="cancelar.html">Cancelar Reservas</a></li>
            <li class="login"><a href="loggedin.html">Área do Usuário</a></li>
        </ul>
    </nav>

    <main>
        <section class="intro">
            <h1>Minhas Reservas</h1>
            <p>Visualize e gerencie todas as suas reservas de salas</p>
        </section>

        <section class="content">
            <div id="loading" style="text-align: center; padding: 20px; display: none;">
                <p>Carregando reservas...</p>
            </div>
            
            <div id="reservas-content">
                <table id="tabela-reservas">
                    <thead>
                        <tr>
                            <th>Reservante</th>
                            <th>RA</th>
                            <th>Sala</th>
                            <th>Data</th>
                            <th>Horário</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 UniCEUB - Todos os direitos reservados</p>
    </footer>

    <script type="module">
        import { verificarAutenticacao } from './auth.js'; 

        // Agora API_URL será 'https://projeto-integrador-znob.onrender.com'
        // Portanto, *DEVE-SE* adicionar '/api' nas rotas que o usam no backend.
        const API_URL = 'https://projeto-integrador-znob.onrender.com'; 

        document.addEventListener("DOMContentLoaded", async () => {
            console.log('DOMContentLoaded disparado em historico.html');
            const autenticado = await verificarAutenticacao();
            console.log('Usuário autenticado:', autenticado);
            
            if (autenticado) {
                carregarReservas();
            } else {
                const tbody = document.querySelector('#tabela-reservas tbody');
                tbody.innerHTML = `<tr><td colspan="6">Você não está logado. Por favor, <a href="login.html">faça login</a>.</td></tr>`;
                document.getElementById('loading').style.display = 'none';
            }
        });

        async function carregarReservas() {
            const loading = document.getElementById('loading');
            const tbody = document.querySelector('#tabela-reservas tbody');
            
            loading.style.display = 'block';
            tbody.innerHTML = '';

            const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
            console.log('Dados do usuário do localStorage (Historico):', usuario);

            if (!usuario || !usuario.id || !usuario.token) { 
                loading.style.display = 'none';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">
                            Você não está logado. <a href="login.html">Faça login</a>.
                        </td>
                    </tr>
                `;
                return;
            }

            try {
                // ATENÇÃO AQUI: ADICIONANDO '/api' porque API_URL não o possui.
                const url = `${API_URL}/api/reservas/usuario/${usuario.id}`; 
                console.log('Tentando buscar reservas de (Historico):', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${usuario.token}` 
                    }
                }); 
                
                console.log('Resposta do fetch (Historico):', response);

                if (!response.ok) {
                    let errorMsg = 'Erro desconhecido ao carregar reservas.';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (jsonError) {
                        errorMsg = `Erro ao carregar reservas: Status ${response.status}. Resposta não é JSON.`;
                    }
                    throw new Error(errorMsg);
                }

                const reservas = await response.json();
                console.log('Reservas recebidas (Historico):', reservas);

                if (reservas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <p>Nenhuma reserva encontrada.</p>
                                <p style="margin-top: 10px;">
                                    <a href="reservar.html" style="color: #003366; text-decoration: none; font-weight: bold;">
                                        Fazer uma reserva →
                                    </a>
                                </p>
                            </td>
                        </tr>
                    `;
                } else {
                    reservas.forEach(reserva => {
                        const novaLinha = document.createElement('tr');
                        const statusColor = getStatusColor(reserva.status || 'Pendente');
                        
                        novaLinha.innerHTML = `
                            <td>${reserva.nome_reservante || ''}</td>
                            <td>${reserva.ra || ''}</td>
                            <td>${reserva.sala_nome} (${reserva.bloco}, ${reserva.tipo})</td>
                            <td>${formatarData(reserva.data)}</td>
                            <td>${formatarHorario(reserva.horario)}</td>
                            <td><span style="color: ${statusColor}; font-weight: bold;">${reserva.status || 'Pendente'}</span></td>
                        `;
                        tbody.appendChild(novaLinha);
                    });
                }
            } catch (e) {
                console.error("Erro ao carregar reservas (Historico, catch block):", e);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #dc3545;">
                            Erro ao carregar reservas. Tente recarregar a página. ${e.message || ''}
                        </td>
                    </tr>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Funções de formatação e statusColor (iguais às anteriores)
        function formatarData(data) {
            if (!data) return '';
            try {
                const [ano, mes, dia] = data.split('-');
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return data;
            }
        }

        function formatarHorario(horario) {
            if (!horario) return '';
            try {
                const [hora, minuto] = horario.split(':');
                return `${hora}:${minuto}`;
            } catch (e) {
                return horario;
            }
        }

        function getStatusColor(status) {
            switch ((status || '').toLowerCase()) {
                case 'confirmado':
                case 'aprovado':
                    return '#28a745';
                case 'cancelado':
                case 'rejeitado':
                    return '#dc3545';
                case 'pendente':
                default:
                    return '#ffc107';
            }
        }
    </script>
</body>
</html>